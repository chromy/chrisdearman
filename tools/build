#!/usr/bin/env python3
import os
import subprocess
import pathlib
import json

ROOT = os.path.dirname(os.path.dirname(__file__))
OUT = os.path.join(ROOT, "out")
SITE = os.path.join(OUT, "site")
SRC_PATH = os.path.join(ROOT, "src")
INDEX_TEMPLATE_PATH = os.path.join(SRC_PATH, "index.html")
CSS_PATH = os.path.join(SRC_PATH, "style.css")
JS_PATH = os.path.join(SRC_PATH, "script.js")
FAVICON_PATH = os.path.join(SRC_PATH, "favicon-data-url.txt")
OBIT_PATH = os.path.join(SRC_PATH, "obit.txt")

OUTPUT_PATH = os.path.join(SITE, "index.html")
ASSETS_PATH = os.path.join(SITE, "assets")

PHOTO_FILENAMES = (
    '1523555084138-6d802839-092c-4dbd-9145-7f0b48904a30.jpg-148e04467d086cb3032ce0b36566c8f4405914c88d5dd7048c16a0b394381f44',
    #'IMG_0049.jpg-85833f654bbfcab50e50fdecb47771ccb66cd7741c8f1a88766448c954613d6e',
    'IMG_20150807_153349180_TOP.jpg-7356bf4cf78c63c635745eeddec4657575af068e2583f311517e8a8d6e03c1bd',
    'IMG_20151019_164919670_TOP.jpg-e01746dd875dd4c78026865c03bfd7f6fcd14b1ed426763b6ae1ca7354f9f611',
    #'IMG_20151229_082030.jpg-81d50dbfaf1e2c87234f56bf22a372c24248c02585a003d68743b5e0298b990a',
    'IMG_20160819_155729.jpg-d09e41074d9186151d60bc13537ff3c733591f99182c0b8284fd50778671e8ca',
    'IMG_20160820_170759.jpg-06f90d76ac1459df6f4f57c98a1882a33b0ccd54af2a607be6d6b463aba1f3b7',
    'IMG_20180421_153621.jpg-b91244885a0a08430169d384a08bbcd2e790417a7dc412fc772091573dafde27',
    'IMG_20191224_130542.jpg-4f8b2468315b8429b6cebf78e3fd9f2dddf1358d1382b4c755d3a57d53fbf732',
    'Masters_2012_09_18_20120918-124101_IMG_1307.jpg-4f43dff10b2968dc89fc28fd792da2bb44ce3f9713f555493d286467185c7aa3',
    'Masters_2012_09_18_20120918-124101_IMG_1341.jpg-8dd5209801899cff29745dcddfb8bc9d686dac92fab3d4653aee7dcc119e6657',
    'Masters_2013_08_06_20130806-165536_IMG_2172.jpg-f6c7c23b1073e0ccf823014d0952ed6ec0732290c2bd62eb157479827a58e0d7',
    #'Scan 0.jpg-bfb2a061260c6af41633e97bdf2628b53c5debb1959cbfc7362aaac58c5e9164',
    'Scan 1.jpg-80ece0681433fb4a914e575501263a5d24ea3b965e0155fa3e7e4b258e72ddd0',
    'Scan 10.jpg-be11a9c5e94b7445e82474ad58c90764f25e9adbea57e295c3a9154867f15088',
    'Scan 2.jpg-8fa5db12f4085a35d0189aceaf6d28d355cfbe192eb94e2d3c6df05ae92cb7ea',
    'Scan 3.jpg-7b6a1501fe2f894318272187c307214ff981844fcd5869bb982dd12e9d59bed5',
    'Scan 4.jpg-6294adfa10b28995722f2924ea98c97b31ceaf4b4cb87283bd67bf2aa7bff849',
    'Scan 5.jpg-e734c82034d8550eb323036cd9c7335ab31a81f5e724197f9aece3710ec3c655',
    'Scan 6.jpg-aaefb7b70a3c74f277e09efdfc3a4b5696f03d1aa3d50a1f6107c8a3b4730fc1',
    'Scan 7.jpg-8196f1b2d071351dd8ef906c38b06b3b97b617f08aed3bf325330aa3e3bc0532',
    'Scan 8.jpg-2022da34d2d2fb1003d420d31645ee3fa273be9a32725325d62c310344df7cc5',
    'Scan 9.jpg-083bfb6343dbabe319e6820e1ef8deaff4418ffb68219214425d9e3a5531ce57',
    'Scan.jpg-58b1866ce2ce4d4cc2508332f393de08f30fddc6798275afa8f7cd8c0ed5ab60',
)

MEMORY_HTML = '''
<div class="flex pt-3">
  <div class="mb-4 flex-shrink-0 sm:mb-0 sm:mr-4">
  {avatar}
  </div>
  <div>
    <p class="mt-1">{text}</p>
    <h4 style="font-variant-caps: small-caps;">{contributor}</h4>
  </div>
</div>
'''

AVATAR_PLACEHOLDER = '''
<span class="inline-block h-16 w-16 rounded-full overflow-hidden bg-gray-100">
  <svg class="h-full w-full text-gray-300" fill="currentColor" viewBox="0 0 24 24">
    <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" />
  </svg>
</span>
'''

def main():
  pathlib.Path(OUT).mkdir(parents=True, exist_ok=True)
  pathlib.Path(SITE).mkdir(parents=True, exist_ok=True)

  try:
    os.unlink(ASSETS_PATH)
  except FileNotFoundError:
    pass
  os.symlink("../../assets", ASSETS_PATH)

  with open(INDEX_TEMPLATE_PATH) as f:
    template = f.read()
  css = subprocess.check_output([
    "npx",
    "tailwindcss",
    "-i",
    CSS_PATH,
  ]).decode("utf8")
  with open(JS_PATH) as f:
    js = f.read()
  with open(OBIT_PATH) as f:
    obit = f.read()
  with open(FAVICON_PATH) as f:
    favicon = f.read()

  def memory_html(obj):
      try:
        contributor = obj["contributor"]
        text = obj["text"]
      except KeyError:
          return ""

      try:
        avatar_url = obj["avatar_url"]
        avatar = f'<img class="inline-block h-16 w-16 rounded-full" src="{avatar_url}" alt="">'
      except KeyError:
        avatar = AVATAR_PLACEHOLDER

      return MEMORY_HTML.format(
        contributor=contributor,
        text=text,
        avatar=avatar,
      )

  def photo_html(filename):
      return f'<img style="height: fit-content;" class="p-2 block rounded-xl drop-shadow-lg sm:max-w-[50%]" src="/assets/{filename}" alt="">'

  memories = ""
  for name in os.listdir(SRC_PATH):
    if not name.endswith(".json"):
      continue
    path = os.path.join(SRC_PATH, name)
    with open(path) as f:
      obj = json.load(f)
      memories = memories + memory_html(obj)

  photos = ''.join(photo_html(filename) for filename in PHOTO_FILENAMES)

  index_souce = template.format(
    css=css,
    js=js,
    obit=obit,
    memories=memories,
    favicon=favicon,
    photos=photos,
  )
  with open(OUTPUT_PATH, "w") as f:
    f.write(index_souce)

if __name__ == "__main__":
  main()
