#!/usr/bin/env python3
import os
import subprocess
import pathlib

ROOT = os.path.dirname(os.path.dirname(__file__))
OUT = os.path.join(ROOT, "out")
SITE = os.path.join(OUT, "site")
INDEX_TEMPLATE_PATH = os.path.join(ROOT, "src", "index.html")
CSS_PATH = os.path.join(ROOT, "src", "style.css")
JS_PATH = os.path.join(ROOT, "src", "script.js")
OBIT_PATH = os.path.join(ROOT, "src", "obit.txt")
OUTPUT_PATH = os.path.join(SITE, "index.html")
ASSETS_PATH = os.path.join(SITE, "assets")

def main():
  pathlib.Path(OUT).mkdir(parents=True, exist_ok=True)
  pathlib.Path(SITE).mkdir(parents=True, exist_ok=True)

  try:
    os.unlink(ASSETS_PATH)
  except FileNotFoundError:
    pass
  os.symlink("../../assets", ASSETS_PATH)

  with open(INDEX_TEMPLATE_PATH) as f:
    template = f.read()
  css = subprocess.check_output([
    "npx",
    "tailwindcss",
    "-i",
    CSS_PATH,
  ]).decode("utf8")
  with open(JS_PATH) as f:
    js = f.read()
  with open(OBIT_PATH) as f:
    obit = f.read()
  index_souce = template.format(css=css, js=js, obit=obit)
  with open(OUTPUT_PATH, "w") as f:
    f.write(index_souce)

if __name__ == "__main__":
  main()
